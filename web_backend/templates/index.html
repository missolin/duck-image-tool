<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¸­é¸­å›¾ - åª’ä½“å†…å®¹ä¿æŠ¤å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #99ccff 0%, #66b3ff 100%);
            padding: 40px;
            text-align: center;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .tabs {
            display: flex;
            background: #f5f5f5;
        }
        
        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1.1em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        
        .content {
            padding: 20px;
            display: flex;
            gap: 15px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        
        .content.single-column {
            display: block;
        }
        
        .sidebar {
            flex: 0 0 220px;
            background: #f9f9f9;
            border-radius: 8px;
            padding: 12px;
            max-height: calc(100vh - 250px);
            overflow-y: auto;
            display: none;
        }
        
        .sidebar.active {
            display: block;
        }
        
        .main-content {
            flex: 1;
            min-width: 0;
        }
        
        /* è§†é¢‘åˆ—è¡¨æ ·å¼ */
        .video-list-header {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .video-list-header button {
            background: #ff4444;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            cursor: pointer;
        }
        
        .video-list-header button:hover {
            background: #cc0000;
        }
        
        .video-list {
            list-style: none;
        }
        
        .video-item {
            background: white;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .video-item:hover {
            background: #f0f0ff;
            border-color: #667eea;
        }
        
        .video-item.selected {
            background: #e6e6ff;
            border-color: #667eea;
        }
        
        .video-item-name {
            font-size: 0.9em;
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
            word-break: break-all;
        }
        
        .video-item-info {
            font-size: 0.75em;
            color: #666;
        }
        
        .video-item-actions {
            margin-top: 6px;
            display: flex;
            gap: 5px;
        }
        
        .video-item-actions button {
            flex: 1;
            padding: 4px 8px;
            font-size: 0.75em;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-load {
            background: #667eea;
            color: white;
        }
        
        .btn-load:hover {
            background: #5568d3;
        }
        
        .btn-delete {
            background: #ff6b6b;
            color: white;
        }
        
        .btn-delete:hover {
            background: #ff5252;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        input[type="text"],
        input[type="password"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .file-upload {
            border: 3px dashed #e0e0e0;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-upload:hover {
            border-color: #667eea;
            background: #f9f9ff;
        }
        
        .file-upload.dragover {
            border-color: #667eea;
            background: #f0f0ff;
        }
        
        .file-upload input {
            display: none;
        }
        
        .file-info {
            margin-top: 15px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
            display: none;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .result {
            margin-top: 30px;
            padding: 20px;
            background: #f0f9ff;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            display: none;
        }
        
        .result img {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .error {
            background: #fff0f0;
            border-left-color: #ff4444;
            color: #cc0000;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hint {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        /* è§†é¢‘ç¼–è¾‘å™¨æ ·å¼ */
        .video-container {
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            height: 580px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .video-container video {
            position: relative;
            z-index: 1;
            max-height: 100%;
            max-width: 100%;
            object-fit: contain;
        }
        
        .video-placeholder {
            text-align: center;
            color: #999;
            padding: 60px 20px;
        }
        
        .video-placeholder p:first-child {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .video-info {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
        }
        
        .video-info p {
            margin: 8px 0;
            color: #333;
        }
        
        #frame-canvas {
            display: block;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        /* è§†é¢‘åˆå¹¶æ ·å¼ */
        .merge-section {
            margin-top: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        /* æ—¶é—´è½´æ ·å¼ */
        .timeline-container {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            min-height: 120px;
        }
        
        .timeline-header {
            color: #fff;
            font-size: 0.9em;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .timeline-duration {
            color: #52c41a;
            font-weight: 600;
        }
        
        .timeline-tracks {
            background: #1a1a1a;
            border-radius: 6px;
            padding: 10px;
            min-height: 80px;
            position: relative;
        }
        
        .timeline-empty {
            text-align: center;
            color: #666;
            padding: 20px;
            font-size: 0.85em;
        }
        
        .timeline-clips {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .timeline-clip {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 6px;
            padding: 8px 10px;
            color: white;
            font-size: 0.8em;
            cursor: move;
            position: relative;
            min-width: 100px;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .timeline-clip:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            border-color: #52c41a;
        }
        
        .timeline-clip.dragging {
            opacity: 0.5;
        }
        
        .timeline-clip-name {
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .timeline-clip-duration {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .timeline-clip-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.8em;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .timeline-clip-remove:hover {
            background: #ff4444;
        }
        
        .merge-list {
            list-style: none;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .merge-item {
            background: white;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .merge-item-name {
            font-size: 0.9em;
            color: #333;
            flex: 1;
        }
        
        .merge-item-remove {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.85em;
            cursor: pointer;
        }
        
        .merge-item-remove:hover {
            background: #ff5252;
        }
        
        .merge-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .merge-controls button {
            flex: 1;
        }
        
        .merge-progress {
            margin-top: 15px;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #52c41a 0%, #73d13d 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¦† é¸­é¸­å›¾</h1>
            <p>åª’ä½“å†…å®¹ä¿æŠ¤å·¥å…· V1.2</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('encode', this)">ç¼–ç </button>
            <button class="tab" onclick="switchTab('decode', this)">è§£ç </button>
            <button class="tab" onclick="switchTab('merge', this)">è§†é¢‘åˆå¹¶</button>
        </div>
        
        <div class="content" id="main-content">
            <!-- å…¨å±€ä¾§è¾¹æ ï¼ˆè§†é¢‘åˆ—è¡¨ï¼‰ -->
            <div class="sidebar" id="global-sidebar">
                <div class="video-list-header">
                    <span>ğŸ“¹ è§†é¢‘åˆ—è¡¨</span>
                    <button onclick="clearAllVideos()" title="æ¸…ç©ºæ‰€æœ‰">æ¸…ç©º</button>
                </div>
                <ul class="video-list" id="video-list-global">
                    <li style="text-align: center; color: #999; padding: 20px;">æš‚æ— è§†é¢‘</li>
                </ul>
            </div>
            
            <!-- ä¸»å†…å®¹åŒº -->
            <div class="main-content">
            <!-- ç¼–ç æ ‡ç­¾é¡µ -->
            <div id="encode-tab" class="tab-content active">
                <form id="encode-form">
                    <div class="form-group">
                        <label>ä¸Šä¼ æ–‡ä»¶</label>
                        <div class="file-upload" id="encode-upload" tabindex="0">
                            <input type="file" id="encode-file" accept="image/*,video/*">
                            <p>ğŸ“ ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œ</p>
                            <p class="hint">æ”¯æŒå›¾ç‰‡ï¼ˆPNG/JPG/BMP/WEBPï¼‰å’Œè§†é¢‘ï¼ˆMP4/AVI/MOVï¼‰</p>
                            <p class="hint">ğŸ’¡ ä¹Ÿå¯ä»¥ç›´æ¥ Ctrl+V ç²˜è´´å›¾ç‰‡</p>
                        </div>
                        <div class="file-info" id="encode-file-info"></div>
                    </div>
                    
                    <div class="form-group">
                        <label>æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" id="encode-title" placeholder="åœ¨é¸­å­å›¾ä¸Šæ˜¾ç¤ºçš„æ ‡é¢˜">
                    </div>
                    
                    <div class="form-group">
                        <label>å¯†ç ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="password" id="encode-password" placeholder="ç•™ç©ºåˆ™ä¸åŠ å¯†">
                        <p class="hint">è®¾ç½®å¯†ç åï¼Œè§£ç æ—¶éœ€è¦ç›¸åŒå¯†ç </p>
                    </div>
                    
                    <div class="form-group">
                        <label>å‹ç¼©çº§åˆ«</label>
                        <select id="encode-compress">
                            <option value="2">ä½å‹ç¼©ï¼ˆç”»è´¨æœ€å¥½ï¼‰</option>
                            <option value="6">ä¸­å‹ç¼©ï¼ˆå¹³è¡¡ï¼‰</option>
                            <option value="8">é«˜å‹ç¼©ï¼ˆä½“ç§¯æœ€å°ï¼‰</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">ç”Ÿæˆé¸­å­å›¾</button>
                </form>
                
                <div class="loading" id="encode-loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨ç”Ÿæˆé¸­å­å›¾...</p>
                </div>
                
                <div class="result" id="encode-result"></div>
            </div>
            
            <!-- è§£ç æ ‡ç­¾é¡µ -->
            <div id="decode-tab" class="tab-content">
                <form id="decode-form">
                    <div class="form-group">
                        <label>æ–¹å¼1ï¼šä» URL åŠ è½½ï¼ˆæ¨èï¼‰</label>
                        <input type="text" id="decode-url" placeholder="ç²˜è´´å›¾ç‰‡é“¾æ¥ï¼Œä¾‹å¦‚ï¼šhttps://example.com/duck.png">
                        <p class="hint">ğŸ’¡ å³é”®å›¾ç‰‡ â†’ å¤åˆ¶å›¾ç‰‡åœ°å€ â†’ ç²˜è´´åˆ°è¿™é‡Œ</p>
                        <button type="button" class="btn btn-primary" onclick="loadImageFromUrl()" style="margin-top: 10px;">ä» URL åŠ è½½</button>
                    </div>
                    
                    <div style="text-align: center; margin: 20px 0; color: #999;">æˆ–è€…</div>
                    
                    <div class="form-group">
                        <label>æ–¹å¼2ï¼šä¸Šä¼ é¸­å­å›¾</label>
                        <div class="file-upload" id="decode-upload" tabindex="0">
                            <input type="file" id="decode-file" accept="image/png,image/*">
                            <p>ğŸ“ ç‚¹å‡»æˆ–æ‹–æ‹½é¸­å­å›¾åˆ°è¿™é‡Œ</p>
                            <p class="hint">ä»…æ”¯æŒ PNG æ ¼å¼</p>
                            <p class="hint" style="color: #ff6600;">âš ï¸ ç²˜è´´å¯èƒ½å¯¼è‡´å›¾ç‰‡å‹ç¼©ï¼Œæ¨èä¸‹è½½åæ‹–æ‹½</p>
                        </div>
                        <div class="file-info" id="decode-file-info"></div>
                    </div>
                    
                    <div class="form-group">
                        <label>å¯¼å‡ºæ–‡ä»¶åï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" id="decode-filename" placeholder="ç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆæ–‡ä»¶å">
                        <p class="hint">ä¸éœ€è¦å¡«æ‰©å±•åï¼Œä¼šè‡ªåŠ¨æ·»åŠ </p>
                    </div>
                    
                    <div class="form-group">
                        <label>å¯†ç ï¼ˆå¦‚æœæœ‰ï¼‰</label>
                        <input type="password" id="decode-password" placeholder="å¦‚æœç¼–ç æ—¶è®¾ç½®äº†å¯†ç ï¼Œè¯·è¾“å…¥">
                    </div>
                    
                    <button type="submit" class="btn btn-primary">è§£ç æå–</button>
                </form>
                
                <div class="loading" id="decode-loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨è§£ç ...</p>
                </div>
                
                <div class="result" id="decode-result"></div>
            </div>
            
            <!-- è§†é¢‘åˆå¹¶æ ‡ç­¾é¡µ -->
            <div id="merge-tab" class="tab-content">
                <div class="form-group">
                    <label>å¿«é€Ÿä¸Šä¼ </label>
                    <div class="file-upload" id="merge-upload">
                        <input type="file" id="merge-file" accept="video/*" multiple>
                        <p>ğŸ“ ç‚¹å‡»æˆ–æ‹–æ‹½è§†é¢‘æ–‡ä»¶åˆ°è¿™é‡Œ</p>
                        <p class="hint">æ”¯æŒå¤šé€‰ï¼Œå¯ä¸€æ¬¡ä¸Šä¼ å¤šä¸ªè§†é¢‘</p>
                    </div>
                </div>
                
                <!-- è§†é¢‘é¢„è§ˆ -->
                <div class="form-group">
                    <label>æ—¶é—´è½´é¢„è§ˆ</label>
                    <div class="video-container" id="merge-video-container">
                        <video id="merge-video-player" style="width: 100%; border-radius: 8px;"></video>
                        <div class="video-placeholder" id="merge-video-placeholder" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; pointer-events: none;">
                            <div style="text-align: center; color: #999;">
                                <p style="font-size: 3em; margin-bottom: 10px;">ğŸ¬</p>
                                <p>æš‚æ— é¢„è§ˆ</p>
                                <p class="hint">æ·»åŠ è§†é¢‘åˆ°æ—¶é—´è½´åå¯é¢„è§ˆ</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ’­æ”¾æ§åˆ¶ -->
                    <div class="playback-controls" id="playback-controls" style="display: none; margin-top: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <button class="btn-play" onclick="togglePlayback()" id="play-btn" style="padding: 8px 16px; border: none; border-radius: 6px; background: #667eea; color: white; cursor: pointer; font-size: 1.1em;">
                                â–¶ï¸ æ’­æ”¾
                            </button>
                            <span id="current-time-display" style="font-size: 0.9em; color: #666;">00:00</span>
                            <span style="color: #999;">/</span>
                            <span id="total-time-display" style="font-size: 0.9em; color: #666;">00:00</span>
                            <div style="flex: 1;"></div>
                            <button class="btn-capture" onclick="captureFrameFromMerge()" id="capture-frame-btn" style="padding: 8px 16px; border: none; border-radius: 6px; background: #52c41a; color: white; cursor: pointer; font-size: 1em;">
                                ğŸ“¸ æˆªå–å½“å‰å¸§
                            </button>
                        </div>
                        
                        <!-- æ’­æ”¾è¿›åº¦æ¡ -->
                        <div class="playback-progress" style="position: relative; height: 40px; background: #f0f0f0; border-radius: 6px; cursor: pointer;" onclick="seekTimeline(event)">
                            <div class="playback-fill" id="playback-fill" style="position: absolute; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 6px; width: 0%; transition: width 0.1s;"></div>
                            <div class="playhead" id="playhead" style="position: absolute; top: 0; bottom: 0; width: 3px; background: #ff4444; left: 0%; box-shadow: 0 0 8px rgba(255, 68, 68, 0.6);"></div>
                        </div>
                    </div>
                </div>
                
                <!-- æ—¶é—´è½´ -->
                <div class="form-group">
                    <label>æ—¶é—´è½´</label>
                    <div class="timeline-container">
                        <div class="timeline-header">
                            <span>ğŸ“½ï¸ æ‹–æ‹½è§†é¢‘åˆ°è¿™é‡Œæ’åˆ—é¡ºåº</span>
                            <span class="timeline-duration" id="timeline-duration">æ€»æ—¶é•¿: 00:00</span>
                        </div>
                        <div class="timeline-tracks" id="timeline-tracks">
                            <div class="timeline-empty" id="timeline-empty">
                                ä»å·¦ä¾§æ‹–æ‹½è§†é¢‘æˆ–ç‚¹å‡»"æ·»åŠ "æŒ‰é’®
                            </div>
                            <div class="timeline-clips" id="timeline-clips" style="display: none;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- æˆªå¸§ç»“æœ -->
                <div class="result" id="merge-frame-result" style="display: none;">
                    <h3>âœ… æˆªå–æˆåŠŸï¼</h3>
                    <canvas id="merge-frame-canvas" style="max-width: 100%; border-radius: 8px; margin: 15px 0;"></canvas>
                    <p id="merge-frame-info"></p>
                    <button class="btn btn-primary" onclick="downloadMergeFrame()">ä¸‹è½½å›¾ç‰‡</button>
                </div>
                
                <div class="merge-controls">
                    <button class="btn btn-primary" onclick="clearTimeline()" style="background: #ff6b6b;">æ¸…ç©ºæ—¶é—´è½´</button>
                    <button class="btn btn-primary" onclick="mergeVideos()" id="merge-btn" disabled>
                        ğŸ¥ åˆå¹¶å¹¶å¯¼å‡º
                    </button>
                </div>
                
                <div class="merge-progress" id="merge-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%;">0%</div>
                    </div>
                    <p style="text-align: center; margin-top: 10px; color: #666;" id="progress-text">æ­£åœ¨å¤„ç†...</p>
                </div>
                
                <div class="result" id="merge-result"></div>
            </div>
            </div>
        </div>
    
    <script>
        // æ ‡ç­¾é¡µåˆ‡æ¢
        function switchTab(tab, clickedElement) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // å¦‚æœæœ‰ç‚¹å‡»çš„å…ƒç´ ï¼Œæ¿€æ´»å®ƒï¼›å¦åˆ™æ ¹æ® tab åç§°æŸ¥æ‰¾
            if (clickedElement) {
                clickedElement.classList.add('active');
            } else {
                const tabs = document.querySelectorAll('.tab');
                const tabIndex = {'encode': 0, 'decode': 1, 'merge': 2};
                if (tabIndex[tab] !== undefined) {
                    tabs[tabIndex[tab]].classList.add('active');
                }
            }
            
            document.getElementById(tab + '-tab').classList.add('active');
            
            // æ§åˆ¶ä¾§è¾¹æ å’Œå¸ƒå±€
            const sidebar = document.getElementById('global-sidebar');
            const mainContent = document.getElementById('main-content');
            
            if (tab === 'merge') {
                // æ˜¾ç¤ºä¾§è¾¹æ ï¼Œä½¿ç”¨åŒæ å¸ƒå±€
                sidebar.classList.add('active');
                mainContent.classList.remove('single-column');
            } else {
                // éšè—ä¾§è¾¹æ ï¼Œä½¿ç”¨å•æ å¸ƒå±€
                sidebar.classList.remove('active');
                mainContent.classList.add('single-column');
            }
        }
        
        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        function setupFileUpload(uploadId, fileInputId, fileInfoId) {
            const upload = document.getElementById(uploadId);
            const fileInput = document.getElementById(fileInputId);
            const fileInfo = document.getElementById(fileInfoId);
            
            // ç‚¹å‡»ä¸Šä¼ 
            upload.onclick = (e) => {
                // é˜²æ­¢ç‚¹å‡»æ—¶è§¦å‘æ‹–æ‹½åŒºåŸŸçš„å…¶ä»–äº‹ä»¶
                if (e.target === upload || e.target.parentElement === upload) {
                    fileInput.click();
                }
            };
            
            // æ–‡ä»¶é€‰æ‹©å˜åŒ–
            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    fileInfo.style.display = 'block';
                    fileInfo.innerHTML = `
                        <strong>å·²é€‰æ‹©:</strong> ${file.name}<br>
                        <strong>å¤§å°:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB
                    `;
                }
            };
            
            // æ‹–æ‹½ä¸Šä¼  - ä¿®å¤ç‰ˆ
            upload.addEventListener('dragenter', (e) => {
                e.preventDefault();
                e.stopPropagation();
                upload.classList.add('dragover');
            });
            
            upload.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                upload.classList.add('dragover');
            });
            
            upload.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                // åªæœ‰å½“ç¦»å¼€æ•´ä¸ªä¸Šä¼ åŒºåŸŸæ—¶æ‰ç§»é™¤æ ·å¼
                if (e.target === upload) {
                    upload.classList.remove('dragover');
                }
            });
            
            upload.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                upload.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    // åˆ›å»ºæ–°çš„ FileList å¯¹è±¡
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(files[0]);
                    fileInput.files = dataTransfer.files;
                    
                    // è§¦å‘ change äº‹ä»¶
                    const event = new Event('change', { bubbles: true });
                    fileInput.dispatchEvent(event);
                    
                    // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
                    fileInfo.style.display = 'block';
                    fileInfo.innerHTML = `
                        <strong>å·²é€‰æ‹©:</strong> ${files[0].name}<br>
                        <strong>å¤§å°:</strong> ${(files[0].size / 1024 / 1024).toFixed(2)} MB
                    `;
                }
            });
        }
        
        setupFileUpload('encode-upload', 'encode-file', 'encode-file-info');
        setupFileUpload('decode-upload', 'decode-file', 'decode-file-info');
        
        // è§†é¢‘åˆå¹¶é¡µæ–‡ä»¶ä¸Šä¼ ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
        setupMergeUpload('merge-upload', 'merge-file');
        
        // åˆå¹¶é¡µæ–‡ä»¶ä¸Šä¼ å¤„ç†ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
        function setupMergeUpload(uploadId, fileInputId) {
            const upload = document.getElementById(uploadId);
            const fileInput = document.getElementById(fileInputId);
            
            // ç‚¹å‡»ä¸Šä¼ 
            upload.onclick = (e) => {
                if (e.target === upload || e.target.parentElement === upload) {
                    fileInput.click();
                }
            };
            
            // æ–‡ä»¶é€‰æ‹©å˜åŒ–ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
            fileInput.onchange = (e) => {
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    if (file.type.startsWith('video/')) {
                        const url = URL.createObjectURL(file);
                        addVideoToLibrary(file.name, url, file);
                    }
                });
                
                if (files.length > 0) {
                    // è‡ªåŠ¨åˆ‡æ¢åˆ°åˆå¹¶æ ‡ç­¾é¡µ
                    switchTab('merge');
                }
            };
            
            // æ‹–æ‹½ä¸Šä¼ 
            upload.ondragover = (e) => {
                e.preventDefault();
                upload.classList.add('dragover');
            };
            
            upload.ondragleave = () => {
                upload.classList.remove('dragover');
            };
            
            upload.ondrop = (e) => {
                e.preventDefault();
                upload.classList.remove('dragover');
                
                const files = Array.from(e.dataTransfer.files);
                files.forEach(file => {
                    if (file.type.startsWith('video/')) {
                        const url = URL.createObjectURL(file);
                        addVideoToLibrary(file.name, url, file);
                    }
                });
            };
        }
        
        // ç²˜è´´å›¾ç‰‡åŠŸèƒ½ï¼ˆæ”¹è¿›ç‰ˆï¼šä¿æŒåŸå§‹è´¨é‡ï¼‰
        function setupPasteImage(uploadId, fileInputId, fileInfoId) {
            const upload = document.getElementById(uploadId);
            const fileInput = document.getElementById(fileInputId);
            const fileInfo = document.getElementById(fileInfoId);
            
            // ç›‘å¬æ•´ä¸ªæ–‡æ¡£çš„ç²˜è´´äº‹ä»¶
            document.addEventListener('paste', async (e) => {
                // æ£€æŸ¥å½“å‰æ˜¯å¦åœ¨å¯¹åº”çš„æ ‡ç­¾é¡µ
                const currentTab = document.querySelector('.tab-content.active');
                if (!currentTab.contains(upload)) {
                    return;
                }
                
                const items = e.clipboardData.items;
                let foundImage = false;
                
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    
                    // ä¼˜å…ˆå¤„ç†æ–‡ä»¶ç±»å‹ï¼ˆä¿æŒåŸå§‹è´¨é‡ï¼‰
                    if (item.kind === 'file' && item.type.indexOf('image') !== -1) {
                        e.preventDefault();
                        foundImage = true;
                        
                        const blob = item.getAsFile();
                        
                        // å¦‚æœæ˜¯ PNGï¼Œç›´æ¥ä½¿ç”¨ï¼ˆä¸é‡æ–°ç¼–ç ï¼‰
                        let finalFile;
                        if (blob.type === 'image/png') {
                            finalFile = new File([blob], `pasted-${Date.now()}.png`, { type: 'image/png' });
                        } else {
                            // å…¶ä»–æ ¼å¼è½¬ä¸º PNGï¼ˆæ— æŸï¼‰
                            try {
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                const img = await createImageBitmap(blob);
                                
                                canvas.width = img.width;
                                canvas.height = img.height;
                                ctx.drawImage(img, 0, 0);
                                
                                // è½¬ä¸º PNG Blobï¼ˆæ— æŸï¼‰
                                const pngBlob = await new Promise(resolve => {
                                    canvas.toBlob(resolve, 'image/png', 1.0);
                                });
                                
                                finalFile = new File([pngBlob], `pasted-${Date.now()}.png`, { type: 'image/png' });
                            } catch (err) {
                                console.error('å›¾ç‰‡è½¬æ¢å¤±è´¥:', err);
                                finalFile = new File([blob], `pasted-${Date.now()}.png`, { type: blob.type });
                            }
                        }
                        
                        // è®¾ç½®åˆ° input
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(finalFile);
                        fileInput.files = dataTransfer.files;
                        
                        // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯ï¼ˆå¸¦è­¦å‘Šï¼‰
                        fileInfo.style.display = 'block';
                        const sizeWarning = finalFile.size < 1024 * 1024 ? 
                            '<br><span style="color: #ff6600;">âš ï¸ æ–‡ä»¶è¾ƒå°ï¼Œå¯èƒ½è¢«å‹ç¼©ã€‚å»ºè®®ä¸‹è½½åæ‹–æ‹½ä¸Šä¼ </span>' : '';
                        fileInfo.innerHTML = `
                            <strong>âœ… å·²ç²˜è´´å›¾ç‰‡</strong><br>
                            <strong>å¤§å°:</strong> ${(finalFile.size / 1024 / 1024).toFixed(2)} MB<br>
                            <strong>ç±»å‹:</strong> ${finalFile.type}${sizeWarning}
                        `;
                        
                        // æ·»åŠ è§†è§‰åé¦ˆ
                        upload.style.borderColor = '#667eea';
                        upload.style.background = '#f0f0ff';
                        setTimeout(() => {
                            upload.style.borderColor = '';
                            upload.style.background = '';
                        }, 500);
                        
                        break;
                    }
                }
                
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡ï¼Œæç¤ºç”¨æˆ·
                if (!foundImage && e.clipboardData.items.length > 0) {
                    const hasImage = Array.from(e.clipboardData.items).some(item => 
                        item.type.indexOf('image') !== -1
                    );
                    
                    if (hasImage) {
                        fileInfo.style.display = 'block';
                        fileInfo.innerHTML = `
                            <strong>âš ï¸ æç¤º</strong><br>
                            æ£€æµ‹åˆ°å›¾ç‰‡ä½†å¯èƒ½è¢«å‹ç¼©ã€‚å»ºè®®ï¼š<br>
                            1. å³é”®å›¾ç‰‡ â†’ "å¤åˆ¶å›¾ç‰‡"<br>
                            2. æˆ–è€…ç›´æ¥ä¸‹è½½åæ‹–æ‹½ä¸Šä¼ ï¼ˆæ¨èï¼‰
                        `;
                    }
                }
            });
            
            // æ·»åŠ ç„¦ç‚¹æç¤º
            upload.addEventListener('focus', () => {
                upload.style.borderColor = '#667eea';
            });
            
            upload.addEventListener('blur', () => {
                upload.style.borderColor = '';
            });
        }
        
        setupPasteImage('encode-upload', 'encode-file', 'encode-file-info');
        setupPasteImage('decode-upload', 'decode-file', 'decode-file-info');
        
        // ä» URL åŠ è½½å›¾ç‰‡
        async function loadImageFromUrl() {
            const urlInput = document.getElementById('decode-url');
            const fileInput = document.getElementById('decode-file');
            const fileInfo = document.getElementById('decode-file-info');
            const url = urlInput.value.trim();
            
            if (!url) {
                alert('è¯·è¾“å…¥å›¾ç‰‡ URL');
                return;
            }
            
            fileInfo.style.display = 'block';
            fileInfo.innerHTML = '<strong>â³ æ­£åœ¨åŠ è½½å›¾ç‰‡...</strong>';
            
            try {
                // é€šè¿‡åç«¯ä»£ç†è·å–å›¾ç‰‡ï¼ˆé¿å…è·¨åŸŸé—®é¢˜ï¼‰
                const response = await fetch('/api/fetch-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'åŠ è½½å¤±è´¥');
                }
                
                const blob = await response.blob();
                const filename = url.split('/').pop().split('?')[0] || 'image.png';
                const file = new File([blob], filename, { type: blob.type });
                
                // è®¾ç½®åˆ°æ–‡ä»¶è¾“å…¥æ¡†
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                fileInput.files = dataTransfer.files;
                
                fileInfo.innerHTML = `
                    <strong>âœ… åŠ è½½æˆåŠŸ</strong><br>
                    <strong>æ–‡ä»¶å:</strong> ${filename}<br>
                    <strong>å¤§å°:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                    <strong>ç±»å‹:</strong> ${file.type}
                `;
                
                // æ¸…ç©º URL è¾“å…¥æ¡†
                urlInput.value = '';
                
            } catch (error) {
                fileInfo.innerHTML = `
                    <strong style="color: #cc0000;">âŒ åŠ è½½å¤±è´¥</strong><br>
                    ${error.message}<br>
                    <small>è¯·æ£€æŸ¥ URL æ˜¯å¦æ­£ç¡®ï¼Œæˆ–è€…å°è¯•ä¸‹è½½åä¸Šä¼ </small>
                `;
            }
        }
        
        // ç¼–ç è¡¨å•æäº¤
        document.getElementById('encode-form').onsubmit = async (e) => {
            e.preventDefault();
            
            const fileInput = document.getElementById('encode-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('title', document.getElementById('encode-title').value);
            formData.append('password', document.getElementById('encode-password').value);
            formData.append('compress', document.getElementById('encode-compress').value);
            
            const loading = document.getElementById('encode-loading');
            const result = document.getElementById('encode-result');
            const btn = e.target.querySelector('button');
            
            loading.style.display = 'block';
            result.style.display = 'none';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/encode', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'ç¼–ç å¤±è´¥');
                }
                
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                
                // ç”Ÿæˆæ–‡ä»¶åï¼šæ ‡é¢˜_æ—¥æœŸ_æ—¶é—´
                const title = document.getElementById('encode-title').value.trim() || 'duck';
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
                const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '');
                const filename = `${title}_${dateStr}_${timeStr}.png`;
                
                result.className = 'result';
                result.innerHTML = `
                    <h3>âœ… ç”ŸæˆæˆåŠŸï¼</h3>
                    <img src="${url}" alt="é¸­å­å›¾">
                    <br><br>
                    <p>æ–‡ä»¶å: ${filename}</p>
                    <a href="${url}" download="${filename}" class="btn btn-primary">ä¸‹è½½é¸­å­å›¾</a>
                `;
                result.style.display = 'block';
                
            } catch (error) {
                result.className = 'result error';
                result.innerHTML = `<h3>âŒ é”™è¯¯</h3><p>${error.message}</p>`;
                result.style.display = 'block';
            } finally {
                loading.style.display = 'none';
                btn.disabled = false;
            }
        };
        
        // è§£ç è¡¨å•æäº¤
        document.getElementById('decode-form').onsubmit = async (e) => {
            e.preventDefault();
            
            const fileInput = document.getElementById('decode-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('è¯·å…ˆé€‰æ‹©é¸­å­å›¾');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('password', document.getElementById('decode-password').value);
            
            const loading = document.getElementById('decode-loading');
            const result = document.getElementById('decode-result');
            const btn = e.target.querySelector('button');
            
            loading.style.display = 'block';
            result.style.display = 'none';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/decode', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'è§£ç å¤±è´¥');
                }
                
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                
                // è·å–åŸå§‹æ–‡ä»¶åå’Œç±»å‹
                let originalFilename = response.headers.get('Content-Disposition')?.match(/filename="(.+)"/)?.[1] || 'recovered';
                const contentType = response.headers.get('Content-Type') || '';
                
                // ä» Content-Type æ¨æ–­æ‰©å±•å
                const mimeToExt = {
                    'video/mp4': 'mp4',
                    'video/avi': 'avi',
                    'video/quicktime': 'mov',
                    'image/png': 'png',
                    'image/jpeg': 'jpg',
                    'image/gif': 'gif',
                    'image/bmp': 'bmp',
                    'image/webp': 'webp',
                    'text/plain': 'txt'
                };
                
                // è·å–ç”¨æˆ·è‡ªå®šä¹‰æ–‡ä»¶å
                const customFilename = document.getElementById('decode-filename').value.trim();
                
                // ç”Ÿæˆæœ€ç»ˆæ–‡ä»¶å
                let finalFilename;
                if (customFilename) {
                    // ç”¨æˆ·æŒ‡å®šäº†æ–‡ä»¶åï¼Œä¿ç•™åŸæ‰©å±•å
                    let ext = 'bin';
                    if (originalFilename.includes('.')) {
                        ext = originalFilename.split('.').pop();
                    } else if (mimeToExt[contentType]) {
                        ext = mimeToExt[contentType];
                    }
                    
                    // å¦‚æœç”¨æˆ·å·²ç»å†™äº†æ‰©å±•åï¼Œå°±ä¸é‡å¤æ·»åŠ 
                    if (customFilename.includes('.')) {
                        finalFilename = customFilename;
                    } else {
                        finalFilename = `${customFilename}.${ext}`;
                    }
                } else {
                    // è‡ªåŠ¨ç”Ÿæˆï¼šæ—¥æœŸ_æ—¶é—´_åŸæ–‡ä»¶å
                    const now = new Date();
                    const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
                    const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '');
                    
                    // æ­£ç¡®å¤„ç†æ‰©å±•å
                    let ext = 'bin';
                    let baseName = 'recovered';
                    
                    if (originalFilename.includes('.')) {
                        const parts = originalFilename.split('.');
                        ext = parts.pop(); // æœ€åä¸€ä¸ªæ˜¯æ‰©å±•å
                        baseName = parts.join('.'); // å…¶ä½™éƒ¨åˆ†æ˜¯æ–‡ä»¶å
                    } else {
                        baseName = originalFilename;
                        // ä» Content-Type æ¨æ–­æ‰©å±•å
                        if (mimeToExt[contentType]) {
                            ext = mimeToExt[contentType];
                        }
                    }
                    
                    finalFilename = `duck_decoded_${dateStr}_${timeStr}_${baseName}.${ext}`;
                }
                
                result.className = 'result';
                result.innerHTML = `
                    <h3>âœ… è§£ç æˆåŠŸï¼</h3>
                    <p>æ–‡ä»¶å: ${finalFilename}</p>
                    <br>
                    <a href="${url}" download="${finalFilename}" class="btn btn-primary">ä¸‹è½½æ–‡ä»¶</a>
                `;
                result.style.display = 'block';
                
                // å¦‚æœæ˜¯è§†é¢‘ï¼Œè‡ªåŠ¨åŠ è½½åˆ°è§†é¢‘åº“
                if (contentType.startsWith('video/')) {
                    addVideoToLibrary(finalFilename, url, blob);
                    // è‡ªåŠ¨åˆ‡æ¢åˆ°åˆå¹¶æ ‡ç­¾é¡µ
                    setTimeout(() => {
                        switchTab('merge');
                    }, 500);
                }
                
            } catch (error) {
                result.className = 'result error';
                result.innerHTML = `<h3>âŒ é”™è¯¯</h3><p>${error.message}</p>`;
                result.style.display = 'block';
            } finally {
                loading.style.display = 'none';
                btn.disabled = false;
            }
        };
        
        // ========== è§†é¢‘ç®¡ç†åŠŸèƒ½ ==========
        let videoLibrary = []; // å­˜å‚¨æ‰€æœ‰è§†é¢‘ {id, name, url, blob, duration, size}
        let mergeQueue = []; // åˆå¹¶é˜Ÿåˆ—
        let videoIdCounter = 0;
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        // æˆªå–åˆå¹¶é¡µå½“å‰å¸§
        function captureFrameFromMerge() {
            const videoPlayer = document.getElementById('merge-video-player');
            const canvas = document.getElementById('merge-frame-canvas');
            const frameResult = document.getElementById('merge-frame-result');
            const frameInfo = document.getElementById('merge-frame-info');
            
            if (!videoPlayer.src || mergeQueue.length === 0) {
                alert('è¯·å…ˆæ·»åŠ è§†é¢‘åˆ°æ—¶é—´è½´');
                return;
            }
            
            // è®¾ç½® canvas å°ºå¯¸ä¸ºè§†é¢‘åŸå§‹å°ºå¯¸
            canvas.width = videoPlayer.videoWidth;
            canvas.height = videoPlayer.videoHeight;
            
            // ç»˜åˆ¶å½“å‰å¸§
            const ctx = canvas.getContext('2d');
            ctx.drawImage(videoPlayer, 0, 0, canvas.width, canvas.height);
            
            // æ˜¾ç¤ºç»“æœ
            const currentTime = formatTime(currentPlaybackTime);
            frameInfo.textContent = `æ—¶é—´ç‚¹: ${currentTime} | å°ºå¯¸: ${canvas.width} x ${canvas.height}`;
            frameResult.style.display = 'block';
            
            // æ»šåŠ¨åˆ°ç»“æœ
            frameResult.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // ä¸‹è½½åˆå¹¶é¡µæˆªå–çš„å¸§
        function downloadMergeFrame() {
            const canvas = document.getElementById('merge-frame-canvas');
            
            // ç”Ÿæˆæ–‡ä»¶å
            const timestamp = formatTime(currentPlaybackTime).replace(':', '-');
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
            const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '');
            const filename = `timeline_frame_${timestamp}_${dateStr}_${timeStr}.png`;
            
            // è½¬æ¢ä¸º blob å¹¶ä¸‹è½½
            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            }, 'image/png');
        }
        
        // æ·»åŠ è§†é¢‘åˆ°åº“
        function addVideoToLibrary(name, url, blob) {
            // æ£€æŸ¥é‡åå¹¶è‡ªåŠ¨é‡å‘½å
            let finalName = name;
            let counter = 1;
            
            while (videoLibrary.find(v => v.name === finalName)) {
                // åˆ†ç¦»æ–‡ä»¶åå’Œæ‰©å±•å
                const lastDotIndex = name.lastIndexOf('.');
                if (lastDotIndex > 0) {
                    const baseName = name.substring(0, lastDotIndex);
                    const extension = name.substring(lastDotIndex);
                    finalName = `${baseName} (${counter})${extension}`;
                } else {
                    finalName = `${name} (${counter})`;
                }
                counter++;
            }
            
            const id = ++videoIdCounter;
            const video = {
                id: id,
                name: finalName,
                url: url,
                blob: blob,
                duration: '00:00',
                durationSeconds: 0,
                size: `${(blob.size / 1024 / 1024).toFixed(2)} MB`
            };
            
            // è·å–è§†é¢‘æ—¶é•¿
            const tempVideo = document.createElement('video');
            tempVideo.src = url;
            tempVideo.onloadedmetadata = () => {
                video.duration = formatTime(tempVideo.duration);
                video.durationSeconds = tempVideo.duration;
                updateVideoList();
                updateTimeline(); // æ›´æ–°æ—¶é—´è½´æ˜¾ç¤º
            };
            
            videoLibrary.push(video);
            updateVideoList();
            
            return id;
        }
        
        // æ›´æ–°è§†é¢‘åˆ—è¡¨æ˜¾ç¤º
        function updateVideoList() {
            const videoListGlobal = document.getElementById('video-list-global');
            
            if (videoLibrary.length === 0) {
                videoListGlobal.innerHTML = '<li style="text-align: center; color: #999; padding: 20px;">æš‚æ— è§†é¢‘</li>';
                return;
            }
            
            // å…¨å±€è§†é¢‘åˆ—è¡¨ï¼ˆæ’­æ”¾ã€æ·»åŠ åˆ°åˆå¹¶ã€åˆ é™¤ï¼‰
            videoListGlobal.innerHTML = videoLibrary.map(video => `
                <li class="video-item" data-id="${video.id}" draggable="true" onclick="previewVideoInMerge(${video.id})">
                    <div class="video-item-name">${video.name}</div>
                    <div class="video-item-info">
                        ${video.duration || 'åŠ è½½ä¸­...'} | ${video.size}
                    </div>
                    <div class="video-item-actions">
                        <button class="btn-primary" onclick="addToMergeQueue(${video.id}); event.stopPropagation();" style="background: #52c41a;">æ·»åŠ </button>
                        <button class="btn-delete" onclick="deleteVideoFromLibrary(${video.id}); event.stopPropagation();">åˆ é™¤</button>
                    </div>
                </li>
            `).join('');
            
            // æ·»åŠ æ‹–æ‹½åŠŸèƒ½
            setupVideoListDragDrop();
        }
        
        // åœ¨åˆå¹¶é¡µé¢„è§ˆè§†é¢‘
        function previewVideoInMerge(id) {
            const video = videoLibrary.find(v => v.id === id);
            if (!video) {
                console.log('Video not found:', id);
                return;
            }
            
            // æ£€æŸ¥å½“å‰åœ¨å“ªä¸ªæ ‡ç­¾é¡µ
            const currentTab = document.querySelector('.tab-content.active');
            
            if (currentTab.id === 'merge-tab') {
                // åˆå¹¶é¡µçš„é¢„è§ˆ
                const videoPlayer = document.getElementById('merge-video-player');
                const videoPlaceholder = document.getElementById('merge-video-placeholder');
                
                if (!videoPlayer || !videoPlaceholder) {
                    console.error('Video player elements not found');
                    return;
                }
                
                // éšè—å ä½ç¬¦
                videoPlaceholder.style.opacity = '0';
                videoPlaceholder.style.pointerEvents = 'none';
                
                // è®¾ç½®è§†é¢‘æºå¹¶æ˜¾ç¤º
                videoPlayer.src = video.url;
                videoPlayer.style.opacity = '1';
                videoPlayer.load(); // å¼ºåˆ¶åŠ è½½è§†é¢‘
                
                console.log('Video preview loaded:', video.name);
            }
        }
        
        // è®¾ç½®è§†é¢‘åˆ—è¡¨æ‹–æ‹½åˆ°æ—¶é—´è½´
        function setupVideoListDragDrop() {
            const videoItems = document.querySelectorAll('#video-list-global .video-item');
            
            videoItems.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('video-id', item.dataset.id);
                    e.dataTransfer.effectAllowed = 'copy';
                });
            });
        }
        
        // ä»åº“ä¸­åˆ é™¤è§†é¢‘
        function deleteVideoFromLibrary(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè§†é¢‘å—ï¼Ÿ')) return;
            
            const index = videoLibrary.findIndex(v => v.id === id);
            if (index !== -1) {
                URL.revokeObjectURL(videoLibrary[index].url);
                videoLibrary.splice(index, 1);
                updateVideoList();
                
                // åŒæ—¶ä»æ—¶é—´è½´ä¸­ç§»é™¤
                mergeQueue = mergeQueue.filter(v => v.id !== id);
                updateTimeline();
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰è§†é¢‘
        function clearAllVideos() {
            if (videoLibrary.length === 0) return;
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è§†é¢‘å—ï¼Ÿ')) return;
            
            videoLibrary.forEach(v => URL.revokeObjectURL(v.url));
            videoLibrary = [];
            mergeQueue = [];
            updateVideoList();
            updateTimeline();
        }
        
        // ========== è§†é¢‘åˆå¹¶åŠŸèƒ½ ==========
        
        let isPlaying = false;
        let currentPlaybackTime = 0;
        let totalDuration = 0;
        let playbackInterval = null;
        
        // æ·»åŠ åˆ°æ—¶é—´è½´
        function addToMergeQueue(id) {
            const video = videoLibrary.find(v => v.id === id);
            if (!video) return;
            
            // æ£€æŸ¥æ˜¯å¦å·²åœ¨é˜Ÿåˆ—ä¸­
            if (mergeQueue.find(v => v.id === id)) {
                alert('è¯¥è§†é¢‘å·²åœ¨æ—¶é—´è½´ä¸­');
                return;
            }
            
            mergeQueue.push(video);
            updateTimeline();
            updatePlaybackPreview();
            
            // å¦‚æœä¸åœ¨åˆå¹¶é¡µï¼Œè‡ªåŠ¨åˆ‡æ¢
            const currentTab = document.querySelector('.tab-content.active');
            if (currentTab.id !== 'merge-tab') {
                switchTab('merge');
            }
        }
        
        // æ›´æ–°æ’­æ”¾é¢„è§ˆ
        function updatePlaybackPreview() {
            const playbackControls = document.getElementById('playback-controls');
            const videoPlaceholder = document.getElementById('merge-video-placeholder');
            
            if (mergeQueue.length > 0) {
                playbackControls.style.display = 'block';
                videoPlaceholder.style.opacity = '0';
                
                // è®¡ç®—æ€»æ—¶é•¿
                totalDuration = mergeQueue.reduce((sum, v) => sum + (v.durationSeconds || 0), 0);
                document.getElementById('total-time-display').textContent = formatTime(totalDuration);
                
                // åŠ è½½ç¬¬ä¸€ä¸ªè§†é¢‘
                if (!isPlaying) {
                    loadVideoAtTime(0);
                }
            } else {
                playbackControls.style.display = 'none';
                videoPlaceholder.style.opacity = '1';
                stopPlayback();
            }
        }
        
        // åœ¨æŒ‡å®šæ—¶é—´åŠ è½½è§†é¢‘
        function loadVideoAtTime(time) {
            let accumulatedTime = 0;
            let targetVideo = null;
            let videoStartTime = 0;
            
            for (const video of mergeQueue) {
                const videoDuration = video.durationSeconds || 0;
                if (time >= accumulatedTime && time < accumulatedTime + videoDuration) {
                    targetVideo = video;
                    videoStartTime = time - accumulatedTime;
                    break;
                }
                accumulatedTime += videoDuration;
            }
            
            if (targetVideo) {
                const videoPlayer = document.getElementById('merge-video-player');
                
                // å¦‚æœæ˜¯æ–°è§†é¢‘ï¼ŒåŠ è½½å®ƒ
                if (videoPlayer.src !== targetVideo.url) {
                    videoPlayer.src = targetVideo.url;
                    videoPlayer.onloadedmetadata = () => {
                        videoPlayer.currentTime = videoStartTime;
                        if (isPlaying) {
                            videoPlayer.play();
                        }
                    };
                } else {
                    videoPlayer.currentTime = videoStartTime;
                    if (isPlaying) {
                        videoPlayer.play();
                    }
                }
            }
        }
        
        // åˆ‡æ¢æ’­æ”¾/æš‚åœ
        function togglePlayback() {
            if (mergeQueue.length === 0) {
                alert('è¯·å…ˆæ·»åŠ è§†é¢‘åˆ°æ—¶é—´è½´');
                return;
            }
            
            if (isPlaying) {
                stopPlayback();
            } else {
                startPlayback();
            }
        }
        
        // å¼€å§‹æ’­æ”¾
        function startPlayback() {
            isPlaying = true;
            const playBtn = document.getElementById('play-btn');
            playBtn.innerHTML = 'â¸ï¸ æš‚åœ';
            
            const videoPlayer = document.getElementById('merge-video-player');
            videoPlayer.play();
            
            // ç›‘å¬è§†é¢‘æ’­æ”¾
            videoPlayer.ontimeupdate = () => {
                if (!isPlaying) return;
                
                // è®¡ç®—å½“å‰åœ¨æ—¶é—´è½´ä¸­çš„ä½ç½®
                let accumulatedTime = 0;
                let currentVideoIndex = -1;
                
                for (let i = 0; i < mergeQueue.length; i++) {
                    const video = mergeQueue[i];
                    const videoDuration = video.durationSeconds || 0;
                    
                    if (videoPlayer.src === video.url) {
                        currentVideoIndex = i;
                        currentPlaybackTime = accumulatedTime + videoPlayer.currentTime;
                        break;
                    }
                    accumulatedTime += videoDuration;
                }
                
                // æ›´æ–°è¿›åº¦æ˜¾ç¤º
                updatePlaybackProgress();
            };
            
            // ç›‘å¬è§†é¢‘ç»“æŸ
            videoPlayer.onended = () => {
                if (!isPlaying) return;
                
                // æŸ¥æ‰¾å½“å‰è§†é¢‘åœ¨é˜Ÿåˆ—ä¸­çš„ä½ç½®
                let currentIndex = mergeQueue.findIndex(v => v.url === videoPlayer.src);
                
                if (currentIndex !== -1 && currentIndex < mergeQueue.length - 1) {
                    // æ’­æ”¾ä¸‹ä¸€ä¸ªè§†é¢‘
                    const nextVideo = mergeQueue[currentIndex + 1];
                    videoPlayer.src = nextVideo.url;
                    videoPlayer.onloadedmetadata = () => {
                        videoPlayer.currentTime = 0;
                        videoPlayer.play();
                    };
                } else {
                    // æ’­æ”¾å®Œæˆ
                    stopPlayback();
                    currentPlaybackTime = 0;
                    loadVideoAtTime(0);
                    updatePlaybackProgress();
                }
            };
        }
        
        // åœæ­¢æ’­æ”¾
        function stopPlayback() {
            isPlaying = false;
            const playBtn = document.getElementById('play-btn');
            playBtn.innerHTML = 'â–¶ï¸ æ’­æ”¾';
            
            const videoPlayer = document.getElementById('merge-video-player');
            videoPlayer.pause();
        }
        
        // æ›´æ–°æ’­æ”¾è¿›åº¦
        function updatePlaybackProgress() {
            const progress = totalDuration > 0 ? (currentPlaybackTime / totalDuration) * 100 : 0;
            
            document.getElementById('playback-fill').style.width = progress + '%';
            document.getElementById('playhead').style.left = progress + '%';
            document.getElementById('current-time-display').textContent = formatTime(currentPlaybackTime);
        }
        
        // è·³è½¬åˆ°æŒ‡å®šä½ç½®
        function seekTimeline(event) {
            if (mergeQueue.length === 0) return;
            
            const progressBar = event.currentTarget;
            const rect = progressBar.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const percentage = clickX / rect.width;
            
            currentPlaybackTime = percentage * totalDuration;
            loadVideoAtTime(currentPlaybackTime);
            updatePlaybackProgress();
        }
        
        // æ›´æ–°æ—¶é—´è½´æ˜¾ç¤º
        function updateTimeline() {
            const timelineEmpty = document.getElementById('timeline-empty');
            const timelineClips = document.getElementById('timeline-clips');
            const timelineDuration = document.getElementById('timeline-duration');
            const mergeBtn = document.getElementById('merge-btn');
            
            if (mergeQueue.length === 0) {
                timelineEmpty.style.display = 'block';
                timelineClips.style.display = 'none';
                timelineDuration.textContent = 'æ€»æ—¶é•¿: 00:00';
                mergeBtn.disabled = true;
                updatePlaybackPreview(); // æ›´æ–°é¢„è§ˆçŠ¶æ€
                return;
            }
            
            timelineEmpty.style.display = 'none';
            timelineClips.style.display = 'flex';
            mergeBtn.disabled = mergeQueue.length < 2;
            
            // è®¡ç®—æ€»æ—¶é•¿
            let totalSeconds = 0;
            mergeQueue.forEach(video => {
                if (video.durationSeconds) {
                    totalSeconds += video.durationSeconds;
                }
            });
            timelineDuration.textContent = `æ€»æ—¶é•¿: ${formatTime(totalSeconds)}`;
            
            // æ¸²æŸ“æ—¶é—´è½´ç‰‡æ®µ
            timelineClips.innerHTML = mergeQueue.map((video, index) => `
                <div class="timeline-clip" draggable="true" data-id="${video.id}" data-index="${index}" onclick="previewVideoInMerge(${video.id})">
                    <button class="timeline-clip-remove" onclick="removeFromTimeline(${video.id}); event.stopPropagation();">Ã—</button>
                    <div class="timeline-clip-name" title="${video.name}">${video.name}</div>
                    <div class="timeline-clip-duration">${video.duration || '00:00'}</div>
                </div>
            `).join('');
            
            // æ·»åŠ æ‹–æ‹½äº‹ä»¶
            setupTimelineDragDrop();
            
            // æ›´æ–°æ’­æ”¾é¢„è§ˆ
            updatePlaybackPreview();
        }
        
        // è®¾ç½®æ—¶é—´è½´æ‹–æ‹½
        function setupTimelineDragDrop() {
            const clips = document.querySelectorAll('.timeline-clip');
            const timelineTracks = document.getElementById('timeline-tracks');
            
            let draggedElement = null;
            let draggedIndex = null;
            
            clips.forEach(clip => {
                clip.addEventListener('dragstart', (e) => {
                    draggedElement = clip;
                    draggedIndex = parseInt(clip.dataset.index);
                    clip.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });
                
                clip.addEventListener('dragend', () => {
                    clip.classList.remove('dragging');
                    draggedElement = null;
                });
                
                clip.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(timelineTracks, e.clientX);
                    const dragging = document.querySelector('.dragging');
                    
                    if (afterElement == null) {
                        timelineTracks.querySelector('.timeline-clips').appendChild(dragging);
                    } else {
                        timelineTracks.querySelector('.timeline-clips').insertBefore(dragging, afterElement);
                    }
                });
                
                clip.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const dropIndex = parseInt(clip.dataset.index);
                    
                    if (draggedIndex !== null && draggedIndex !== dropIndex) {
                        // é‡æ–°æ’åº
                        const [removed] = mergeQueue.splice(draggedIndex, 1);
                        const newIndex = draggedIndex < dropIndex ? dropIndex - 1 : dropIndex;
                        mergeQueue.splice(newIndex, 0, removed);
                        updateTimeline();
                    }
                });
            });
            
            // æ—¶é—´è½´åŒºåŸŸæ‹–æ‹½
            timelineTracks.addEventListener('dragover', (e) => {
                e.preventDefault();
            });
            
            timelineTracks.addEventListener('drop', (e) => {
                e.preventDefault();
                // å¦‚æœæ˜¯ä»è§†é¢‘åˆ—è¡¨æ‹–æ‹½è¿‡æ¥çš„
                const videoId = e.dataTransfer.getData('video-id');
                if (videoId) {
                    addToMergeQueue(parseInt(videoId));
                }
            });
        }
        
        function getDragAfterElement(container, x) {
            const draggableElements = [...container.querySelectorAll('.timeline-clip:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = x - box.left - box.width / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        // ä»æ—¶é—´è½´ç§»é™¤
        function removeFromTimeline(id) {
            mergeQueue = mergeQueue.filter(v => v.id !== id);
            updateTimeline();
            // é‡ç½®æ’­æ”¾çŠ¶æ€
            if (isPlaying) {
                stopPlayback();
            }
            currentPlaybackTime = 0;
            updatePlaybackProgress();
        }
        
        // æ¸…ç©ºæ—¶é—´è½´
        function clearTimeline() {
            if (mergeQueue.length === 0) return;
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ—¶é—´è½´å—ï¼Ÿ')) return;
            mergeQueue = [];
            updateTimeline();
            // é‡ç½®æ’­æ”¾çŠ¶æ€
            if (isPlaying) {
                stopPlayback();
            }
            currentPlaybackTime = 0;
            updatePlaybackProgress();
        }
        
        // åˆå¹¶è§†é¢‘ï¼ˆä½¿ç”¨åç«¯ FFmpegï¼‰
        async function mergeVideos() {
            if (mergeQueue.length < 2) {
                alert('è‡³å°‘éœ€è¦2ä¸ªè§†é¢‘æ‰èƒ½åˆå¹¶');
                return;
            }
            
            const progress = document.getElementById('merge-progress');
            const result = document.getElementById('merge-result');
            const mergeBtn = document.getElementById('merge-btn');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            
            progress.style.display = 'block';
            result.style.display = 'none';
            mergeBtn.disabled = true;
            
            try {
                progressFill.style.width = '10%';
                progressFill.textContent = '10%';
                progressText.textContent = 'æ­£åœ¨å‡†å¤‡è§†é¢‘...';
                
                // åˆ›å»º FormData
                const formData = new FormData();
                
                // æŒ‰é¡ºåºæ·»åŠ è§†é¢‘æ–‡ä»¶
                for (let i = 0; i < mergeQueue.length; i++) {
                    const video = mergeQueue[i];
                    formData.append('files', video.blob, video.name);
                    
                    const percent = 10 + Math.floor((i + 1) / mergeQueue.length * 20);
                    progressFill.style.width = percent + '%';
                    progressFill.textContent = percent + '%';
                }
                
                progressFill.style.width = '30%';
                progressFill.textContent = '30%';
                progressText.textContent = 'æ­£åœ¨ä¸Šä¼ åˆ°æœåŠ¡å™¨...';
                
                // å‘é€åˆ°åç«¯åˆå¹¶
                const response = await fetch('/api/merge-videos', {
                    method: 'POST',
                    body: formData
                });
                
                progressFill.style.width = '60%';
                progressFill.textContent = '60%';
                progressText.textContent = 'æ­£åœ¨åˆå¹¶è§†é¢‘...';
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'åˆå¹¶å¤±è´¥');
                }
                
                progressFill.style.width = '90%';
                progressFill.textContent = '90%';
                progressText.textContent = 'æ­£åœ¨ä¸‹è½½ç»“æœ...';
                
                // è·å–åˆå¹¶åçš„è§†é¢‘
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                
                progressFill.style.width = '100%';
                progressFill.textContent = '100%';
                progressText.textContent = 'å®Œæˆï¼';
                
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
                const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '');
                const filename = `merged_video_${dateStr}_${timeStr}.mp4`;
                
                result.className = 'result';
                result.innerHTML = `
                    <h3>âœ… åˆå¹¶æˆåŠŸï¼</h3>
                    <p>æ–‡ä»¶å: ${filename}</p>
                    <p>è§†é¢‘æ•°é‡: ${mergeQueue.length}</p>
                    <p>æ–‡ä»¶å¤§å°: ${(blob.size / 1024 / 1024).toFixed(2)} MB</p>
                    <br>
                    <a href="${url}" download="${filename}" class="btn btn-primary">ä¸‹è½½åˆå¹¶è§†é¢‘</a>
                `;
                result.style.display = 'block';
                
                setTimeout(() => {
                    progress.style.display = 'none';
                    progressFill.style.width = '0%';
                }, 2000);
                
                mergeBtn.disabled = false;
                
            } catch (error) {
                console.error('åˆå¹¶é”™è¯¯:', error);
                
                result.className = 'result error';
                result.innerHTML = `
                    <h3>âŒ åˆå¹¶å¤±è´¥</h3>
                    <p>${error.message}</p>
                    <p class="hint">æç¤ºï¼šè¯·ç¡®ä¿æœåŠ¡å™¨å·²å®‰è£… FFmpegã€‚</p>
                    <p class="hint">macOS: brew install ffmpeg</p>
                    <p class="hint">Ubuntu: sudo apt install ffmpeg</p>
                `;
                result.style.display = 'block';
                progress.style.display = 'none';
                mergeBtn.disabled = false;
            }
        }
        
        // ä¿®æ”¹ handleVideoFile å‡½æ•°ï¼Œæ·»åŠ åˆ°è§†é¢‘åº“
        function handleVideoFile(file, fileInfo) {
            fileInfo.style.display = 'block';
            fileInfo.innerHTML = `
                <strong>âœ… åŠ è½½æˆåŠŸ</strong><br>
                <strong>æ–‡ä»¶å:</strong> ${file.name}<br>
                <strong>å¤§å°:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                <strong>ç±»å‹:</strong> ${file.type}
            `;
            
            // æ·»åŠ åˆ°è§†é¢‘åº“
            const url = URL.createObjectURL(file);
            addVideoToLibrary(file.name, url, file);
        }
    </script>
</body>
</html>
